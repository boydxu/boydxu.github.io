<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>redux-æºç è§£æ(3)-bindActionCreators&amp;combineReducers</title>
      <link href="/2018/09/12/redux-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(3)-bindActionCreators&amp;combineReducers/"/>
      <url>/2018/09/12/redux-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(3)-bindActionCreators&amp;combineReducers/</url>
      <content type="html"><![CDATA[<p>bindActionCreatorså’ŒcombineReducersé€»è¾‘æ¯”è¾ƒç®€å•,ä¸åƒä¹‹å‰çš„applyMiddlewareé‚£ä¹ˆéš¾ç†è§£</p><h2 id="bindActionCreators"><a href="#bindActionCreators" class="headerlink" title="bindActionCreators"></a>bindActionCreators</h2><p><code>bindActionCreator</code>çš„ä¸»è¦åŠŸèƒ½æ˜¯ç”¨<code>dispatch</code>å°†<code>actionåˆ›å»ºå‡½æ•°</code>åŒ…è£¹èµ·æ¥,è¿”å›çš„å‡½æ•°æ‰§è¡Œåä¼šè‡ªåŠ¨dispatch<code>actionåˆ›å»ºå‡½æ•°</code>ç”Ÿæˆçš„<code>action</code>.</p><p>çœ‹ä¸¤ä¸ªç®€å•ğŸŒ°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(reducer)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createIncrementAction</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        type: <span class="string">'increment'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡bindActionCreatorså°†createIncrementActionç”¨dispatchåŒ…è£¹</span></span><br><span class="line"><span class="keyword">let</span> autoDispatchAction = bindActionCreators(createIncrementAction,store.dispatch)</span><br><span class="line"></span><br><span class="line">autoDispatchAction() <span class="comment">// åˆ›å»ºactionå,æ‰§è¡Œäº†dispatch(&#123;type:'increment'&#125;)</span></span><br></pre></td></tr></table></figure><p>å½“actionCreatorsæ˜¯å¯¹è±¡çš„æƒ…å†µ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> actionCreators = &#123;</span><br><span class="line">    increment: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> &#123;<span class="attr">type</span>: <span class="string">'increment'</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    decrement: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> &#123;<span class="attr">type</span>: <span class="string">'decrement'</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> autoDispatchAction = bindActionCreators(actionCreators,store.dispatch)</span><br><span class="line"></span><br><span class="line">actionCreators.increment() <span class="comment">// æœ€ç»ˆæ‰§è¡Œäº†dispatch(&#123;type:'increment'&#125;)</span></span><br><span class="line">actionCreators.decrement() <span class="comment">// æœ€ç»ˆæ‰§è¡Œäº†dispatch(&#123;type:'decrement'&#125;)</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æºç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°, æ‰§è¡Œè¯¥åŒ¿åå‡½æ•°,å…ˆæ‰§è¡ŒåŸactionåˆ›å»ºå‡½æ•°,å†æ‰§è¡Œdispatch</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ ¸å¿ƒä»£ç ,å°±ä¸Šé¢å‡ è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// actionCreators,å‚æ•°æ˜¯actionåˆ›å»ºå‡½æ•°,ä¹Ÿå¯ä»¥æ˜¯å±æ€§éƒ½æ˜¯'actionåˆ›å»ºå‡½æ•°'çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åœ¨actionCreatorsæ˜¯actionåˆ›å»ºå‡½æ•°çš„æƒ…å†µä¸‹ç›´æ¥è°ƒç”¨bindActionCreator</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹actionCreatorsè¿›è¡Œæ ¡éªŒ</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">'object'</span> || actionCreators === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`bindActionCreators expected an object or a function, instead received <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        actionCreators === <span class="literal">null</span> ? <span class="string">'null'</span> : <span class="keyword">typeof</span> actionCreators</span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>. `</span> +</span><br><span class="line">        <span class="string">`Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¯»å–actionCreatorsæ‰€æœ‰å±æ€§å</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</span><br><span class="line">  <span class="comment">// å®šä¹‰ç»“æœå˜é‡</span></span><br><span class="line">  <span class="keyword">const</span> boundActionCreators = &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// éå†actionCreatorsçš„æ‰€æœ‰å±æ€§å€¼</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">const</span> actionCreator = actionCreators[key]</span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥å±æ€§å€¼æ˜¯å‡½æ•°çš„è¯,ç»™ç»“æœå˜é‡æ·»åŠ ç›¸åŒå±æ€§,èµ‹å€¼bindActionCreatorå‡½æ•°çš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¿”å›ç»“æœå˜é‡</span></span><br><span class="line">  <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="combineReducers"><a href="#combineReducers" class="headerlink" title="combineReducers"></a>combineReducers</h2><p>combineReducersçš„ä½œç”¨ä¹Ÿå¾ˆç®€å•,å¯¹å¤šä¸ªreducerè¿›è¡Œäº†åˆå¹¶,æºç è™½ç„¶æœ‰100å¤šè¡Œ,ä½†æ ¸å¿ƒä»£ç ä¹Ÿåªæœ‰60å·¦å³,åŸç†ä¹Ÿéå¸¸ç®€å•,è€æ ·å­,å…ˆçœ‹ä¸ªä½¿ç”¨ğŸŒ°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> incrementReducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> decrementReducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> reducers = combineReducers(&#123;</span><br><span class="line">  incrementReducer,</span><br><span class="line">  decrementReducer,</span><br><span class="line">  otherReducer: decrementReducer,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> store = createStore(reducers)</span><br><span class="line">store.getState()</span><br><span class="line"><span class="comment">// å¾—åˆ°ä¸‹é¢state</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   incrementReducer: 0,</span></span><br><span class="line"><span class="comment">//   decrementReducer: 0,</span></span><br><span class="line"><span class="comment">//   otherReducer: 0</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">'increment'</span></span><br><span class="line">&#125;)</span><br><span class="line">store.getState()</span><br><span class="line"><span class="comment">// å¾—åˆ°ä¸‹é¢state</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   incrementReducer: 0,</span></span><br><span class="line"><span class="comment">//   decrementReducer: -1,</span></span><br><span class="line"><span class="comment">//   otherReducer: -1</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°combineReducersçš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡,å®ƒçš„æ¯ä¸ªå±æ€§éƒ½æ˜¯ä¸€ä¸ªreducer.è¯¥å¯¹è±¡åˆ†åˆ«æœ‰<code>incrementReducer</code>,<code>decrementReducer</code>,<code>otherReducer</code>ä¸‰ä¸ªå±æ€§,æœ€ç»ˆè·å–åˆ°çš„stateæœ‰ç›¸åŒçš„å±æ€§. æ¯ä¸ªreduceråªèƒ½å¯¹å„è‡ªåŒåçš„stateå±æ€§è¿›è¡Œå€¼çš„ä¿®æ”¹.  åœ¨<code>dispatch(action)</code>ä¹‹å,stateæœ‰2ä¸ªå±æ€§å€¼å‘ç”Ÿäº†æ”¹å˜,å› ä¸ºæ¯ä¸ª<code>reducer</code>éƒ½è¢«è°ƒç”¨äº†,ä½†åªæœ‰ä¸‹é¢2ä¸ªreducerçš„switchå‘½ä¸­äº†è¯¥type,æ‰€ä»¥åªæœ‰åŒåçš„stateå±æ€§å€¼å‘ç”Ÿäº†æ”¹å˜.</p><p>ä¸‹é¢çœ‹çœ‹æºç ,ä¸ºäº†æ–¹ä¾¿è§£è¯»,æˆ‘è°ƒæ•´äº†å‡½æ•°é¡ºåº.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ActionTypes <span class="keyword">from</span> <span class="string">'./utils/actionTypes'</span></span><br><span class="line"><span class="keyword">import</span> warning <span class="keyword">from</span> <span class="string">'./utils/warning'</span></span><br><span class="line"><span class="keyword">import</span> isPlainObject <span class="keyword">from</span> <span class="string">'./utils/isPlainObject'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¯»å–reducersæ‰€æœ‰å±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="comment">// éå†reducersæ‰€æœ‰å±æ€§,ä¸‹é¢å‡ è¡Œä»£ç çº¯ç²¹æ˜¯ä¸ºäº†å‡€åŒ–æ‰éfunctionå€¼çš„å±æ€§</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        warning(<span class="string">`No reducer provided for key "<span class="subst">$&#123;key&#125;</span>"`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å±æ€§å€¼ä¸ºfunction,ç»™finalReducersæ·»åŠ åŒåå±æ€§å¹¶èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¯»å–è¿‡æ»¤å±æ€§åçš„reducers(ä¹Ÿå°±æ˜¯finalReducers)çš„æ‰€æœ‰å±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¿˜æ˜¯æ ¡éªŒreducer,å…·ä½“è§assertReducerShapeå‡½æ•°</span></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    assertReducerShape(finalReducers)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// combineReducersçš„æ‰§è¡Œç»“æœæ˜¯ä¸€ä¸ªå‡½æ•°,è¿™ä¸ªå‡½æ•°å°±æ˜¯æ–°çš„reducers,å®ƒå’Œæ™®é€šçš„reducerä¸€æ ·,åªæ¥æ”¶stateå’Œactionå‚æ•°</span></span><br><span class="line">  <span class="comment">// æ³¨æ„: åœ¨ä½¿ç”¨ç»„åˆreducerså,stateçš„åˆå§‹å€¼æ˜¯ä¸ªç©ºå¯¹è±¡,stateä¹Ÿå¯ä»¥åœ¨createStoreæ—¶æŒ‡å®š,ä½†ä¹Ÿå¿…é¡»æ˜¯å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨assertReducerShapeä¸é€šè¿‡çš„æƒ…å†µæ‰§è¡Œä¸‹è°ƒç”¨æ–°çš„recuderæ—¶æŠ›å‡ºé”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> warningMessage = getUnexpectedStateShapeWarningMessage(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        warning(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// stateæ˜¯å¦æ”¹å˜çš„æ ‡è¯†</span></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// æ–°çš„state,æ‰€æœ‰çš„reduceræ‰§è¡Œåçš„ç»“æœéƒ½ä¿å­˜åœ¨é‡Œé¢</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="comment">// éå†reducers</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">      <span class="comment">// keyä¸ºè¯¥reduceråœ¨reducersçš„å±æ€§å</span></span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="comment">// stateåŒå±æ€§åçš„å€¼</span></span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="comment">// æ‰§è¡Œè¯¥reducer,å¾—åˆ°æ–°çš„çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">      <span class="comment">// æ‰§è¡Œç»“æœä¸ºunundefined,æŠ›å‡ºé”™è¯¯</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="comment">// getUndefinedStateErrorMessageå¯¹é”™è¯¯ä¿¡æ¯è¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">        <span class="keyword">const</span> errorMessage = getUndefinedStateErrorMessage(key, action)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æŠŠæ‰§è¡Œç»“æœä¿å­˜åœ¨nextStateå¯¹åº”çš„å±æ€§</span></span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      <span class="comment">// åˆ¤æ–­çŠ¶æ€æ˜¯å¦å‘ç”Ÿæ”¹å˜,æ›´æ–°æ ‡è¯†</span></span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œå®Œæ‰€æœ‰çš„reducerå,æ ¹æ®stateæ˜¯å¦æ”¹å˜çš„æ ‡è¯†,è¿”å›å¯¹åº”ç»“æœ.</span></span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä»¥ä¸Šä¸ºæ ¸å¿ƒä»£ç ,ä¸‹é¢ä»£ç å¯ä»¥å¿½ç•¥</span></span><br><span class="line"><span class="comment">// ä»¥ä¸Šä¸ºæ ¸å¿ƒä»£ç ,ä¸‹é¢ä»£ç å¯ä»¥å¿½ç•¥</span></span><br><span class="line"><span class="comment">// ä»¥ä¸Šä¸ºæ ¸å¿ƒä»£ç ,ä¸‹é¢ä»£ç å¯ä»¥å¿½ç•¥</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹æ‰€æœ‰çš„reducerçš„æ‰§è¡Œç»“æœåšä¸€æ¬¡æ£€æµ‹</span></span><br><span class="line"><span class="comment">// ä¿è¯æ¯ä¸ªreduceræ‰§è¡Œçš„ç»“æœä¸ºéundefined.</span></span><br><span class="line"><span class="comment">// æ³¨æ„!!æ‰§è¡Œç»“æœå¯ä»¥ä¸ºnull</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assertReducerShape</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// éå†æ¯ä¸ªreducer</span></span><br><span class="line">  <span class="built_in">Object</span>.keys(reducers).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reducer = reducers[key]</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿåœ¨creatStoreä¸­æ‰§è¡Œdispatch(&#123;type: ActionTypes.INIT&#125;),ç»“æœä¸ºundefinedå°±æŠ›é”™</span></span><br><span class="line">    <span class="keyword">const</span> initialState = reducer(<span class="literal">undefined</span>, &#123;</span><br><span class="line">      type: ActionTypes.INIT</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`Reducer "<span class="subst">$&#123;key&#125;</span>" returned undefined during initialization. `</span> +</span><br><span class="line">        <span class="string">`If the state passed to the reducer is undefined, you must `</span> +</span><br><span class="line">        <span class="string">`explicitly return the initial state. The initial state may `</span> +</span><br><span class="line">        <span class="string">`not be undefined. If you don't want to set a value for this reducer, `</span> +</span><br><span class="line">        <span class="string">`you can use null instead of undefined.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿåœ¨creatStoreä¸­æ‰§è¡Œdispatch,action.typeä¸ºéšæœºå­—ç¬¦ä¸²,ç»“æœä¸ºundefinedå°±æŠ›é”™</span></span><br><span class="line">    <span class="keyword">const</span> type =</span><br><span class="line">      <span class="string">'@@redux/PROBE_UNKNOWN_ACTION_'</span> +</span><br><span class="line">      <span class="built_in">Math</span>.random()</span><br><span class="line">        .toString(<span class="number">36</span>)</span><br><span class="line">        .substring(<span class="number">7</span>)</span><br><span class="line">        .split(<span class="string">''</span>)</span><br><span class="line">        .join(<span class="string">'.'</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer(<span class="literal">undefined</span>, &#123;</span><br><span class="line">      type</span><br><span class="line">    &#125;) === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`Reducer "<span class="subst">$&#123;key&#125;</span>" returned undefined when probed with a random type. `</span> +</span><br><span class="line">        <span class="string">`Don't try to handle <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        ActionTypes.INIT</span></span></span><br><span class="line"><span class="string"><span class="subst">        &#125;</span> or other actions in "redux/*" `</span> +</span><br><span class="line">        <span class="string">`namespace. They are considered private. Instead, you must return the `</span> +</span><br><span class="line">        <span class="string">`current state for any unknown actions, unless it is undefined, `</span> +</span><br><span class="line">        <span class="string">`in which case you must return the initial state, regardless of the `</span> +</span><br><span class="line">        <span class="string">`action type. The initial state may not be undefined, but can be null.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é”™è¯¯ä¿¡æ¯æ‹¼æ¥</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getUndefinedStateErrorMessage</span>(<span class="params">key, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> actionType = action &amp;&amp; action.type</span><br><span class="line">    <span class="keyword">const</span> actionDescription =</span><br><span class="line">      (actionType &amp;&amp; <span class="string">`action "<span class="subst">$&#123;<span class="built_in">String</span>(actionType)&#125;</span>"`</span>) || <span class="string">'an action'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="string">`Given <span class="subst">$&#123;actionDescription&#125;</span>, reducer "<span class="subst">$&#123;key&#125;</span>" returned undefined. `</span> +</span><br><span class="line">      <span class="string">`To ignore an action, you must explicitly return the previous state. `</span> +</span><br><span class="line">      <span class="string">`If you want this reducer to hold no value, you can return null instead of undefined.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getUnexpectedStateShapeWarningMessage</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    inputState,</span></span></span><br><span class="line"><span class="function"><span class="params">    reducers,</span></span></span><br><span class="line"><span class="function"><span class="params">    action,</span></span></span><br><span class="line"><span class="function"><span class="params">    unexpectedKeyCache</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">    <span class="keyword">const</span> argumentName =</span><br><span class="line">      action &amp;&amp; action.type === ActionTypes.INIT ?</span><br><span class="line">        <span class="string">'preloadedState argument passed to createStore'</span> :</span><br><span class="line">        <span class="string">'previous state received by the reducer'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reducerKeys.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="string">'Store does not have a valid reducer. Make sure the argument passed '</span> +</span><br><span class="line">        <span class="string">'to combineReducers is an object whose values are reducers.'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isPlainObject(inputState)) &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="string">`The <span class="subst">$&#123;argumentName&#125;</span> has unexpected type of "`</span> + &#123;&#125;.toString.call(inputState).match(<span class="regexp">/\s([a-z|A-Z]+)/</span>)[<span class="number">1</span>] +</span><br><span class="line">        <span class="string">`". Expected argument to be an object with the following `</span> +</span><br><span class="line">        <span class="string">`keys: "<span class="subst">$&#123;reducerKeys.join(<span class="string">'", "'</span>)&#125;</span>"`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unexpectedKeys = <span class="built_in">Object</span>.keys(inputState).filter(</span><br><span class="line">      key =&gt; !reducers.hasOwnProperty(key) &amp;&amp; !unexpectedKeyCache[key]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    unexpectedKeys.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      unexpectedKeyCache[key] = <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (action &amp;&amp; action.type === ActionTypes.REPLACE) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unexpectedKeys.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        <span class="string">`Unexpected <span class="subst">$&#123;unexpectedKeys.length &gt; <span class="number">1</span> ? <span class="string">'keys'</span> : <span class="string">'key'</span>&#125;</span> `</span> +</span><br><span class="line">        <span class="string">`"<span class="subst">$&#123;unexpectedKeys.join(<span class="string">'", "'</span>)&#125;</span>" found in <span class="subst">$&#123;argumentName&#125;</span>. `</span> +</span><br><span class="line">        <span class="string">`Expected to find one of the known reducer keys instead: `</span> +</span><br><span class="line">        <span class="string">`"<span class="subst">$&#123;reducerKeys.join(<span class="string">'", "'</span>)&#125;</span>". Unexpected keys will be ignored.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> redux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>redux-æºç è§£æ(2)-applyMiddleware&amp;compose</title>
      <link href="/2018/08/09/redux-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(2)-applyMiddleware&amp;compose/"/>
      <url>/2018/08/09/redux-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(2)-applyMiddleware&amp;compose/</url>
      <content type="html"><![CDATA[<p>è®²åˆ°reduxä¸­é—´ä»¶å°±æ¶‰åŠå¥½å¤šçŸ¥è¯†äº†, å¦‚å‡½æ•°çš„æŸ¯é‡ŒåŒ–ã€<code>store</code>çš„å¼ºåŒ–å™¨<code>enhancer</code>ã€<code>compose</code>å½’å¹¶æ–¹æ³•,è¿™é‡Œä¸è®²å‡½æ•°çš„æŸ¯é‡ŒåŒ–.</p><h2 id="enhancer"><a href="#enhancer" class="headerlink" title="enhancer"></a>enhancer</h2><blockquote><p><code>enhancer</code>æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°.é¡¾åæ€ä¹‰,å®ƒç”¨æ¥å¢åŠ æˆ–è€…ä¿®æ”¹storeçš„åŠŸèƒ½, åœ¨<code>createStore</code>ä¸­åªæœ‰çŸ­çŸ­çš„å‡ è¡Œä»£ç æ¶‰åŠåˆ°å®ƒ.</p></blockquote><p>å…ˆæ¥çœ‹çœ‹å®ƒçš„å‡½æ•°ç­¾å,å®ƒæ¥æ”¶<code>createStore</code>å‡½æ•°,è¿”å›ä¸€ä¸ªå‚æ•°ä¸º<code>reducer</code>å’Œ<code>preloadedState</code>çš„å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enhancer</span>(<span class="params">createStore</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span><span class="function">(<span class="params">reducer, preloadedState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªstore</span></span><br><span class="line">   <span class="comment">// å¯¹storeè¿›è¡Œä¿®æ”¹</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// è¿”å›store</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œ,ä½ éœ€è¦çŸ¥é“å®ƒå¤§æ¦‚çš„æ ·å­å°±å¥½.</p><p>æ¥ä¸ªå®é™…çš„åœºæ™¯,æˆ‘ä»¬éœ€è¦å¯¹æ¯æ¬¡å‘é€çš„<code>action</code>è¿›è¡Œè¾“å‡ºlog.åœ¨ç†è§£<code>enhancer</code>å‰,ä½ å¯ä»¥ä¼šè¿™ä¹ˆå¤„ç†,åœ¨æ¯ä¸ª<code>reducer</code>ä¸­æ·»åŠ ä»£ç ,å¯¹<code>action</code>è¾“å‡º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(action)</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•ç²—æš´çš„è§£å†³æ–¹æ³•,ä½†å¦‚æœ<code>reducer</code>æœ‰å¾ˆå¤šä¸ª,é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¯¹æ‰€æœ‰çš„<code>reducer</code>æ·»åŠ è¿™æ®µä»£ç ,å®¹æ˜“é—æ¼, å½“æˆ‘ä»¬ä¸éœ€è¦è¿™æ®µè¾“å‡ºçš„æ—¶å€™,é‚£ä¹ˆæˆ‘ä»¬åˆè¦ä»å¤šä¸ª<code>reducer</code>ä¸­åˆ é™¤è¿™æ®µä»£ç ,ç»™åæœŸçš„ç»´æŠ¤æé«˜äº†éš¾åº¦.</p><p>è¿™ä¸ªæ—¶å€™è¯¥<code>enhancer</code>å‡ºåœºäº†,<code>reducer</code>æ˜¯åœ¨<code>dispatch</code>ä¸­è¢«è°ƒç”¨çš„,é‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹<code>dispatch</code>å‡½æ•°å°±å®Œç¾åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜,æ¥çœ‹çœ‹ä»£ç .</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> enhancer = <span class="function">(<span class="params">createStore</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">reducer, preloadedState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨åŸcreateStoreåˆ›å»ºstore</span></span><br><span class="line">    <span class="keyword">const</span> store = createStore(reducer, preloadedState)</span><br><span class="line">    <span class="comment">// ä¿å­˜åŸdispatchçš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">let</span> dispatch = store.dispatch</span><br><span class="line">    <span class="comment">// ä¿®æ”¹storeçš„dispatchæ–¹æ³•</span></span><br><span class="line">    store.dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(action);</span><br><span class="line">      <span class="comment">// è°ƒç”¨åŸdispatchæ–¹æ³•</span></span><br><span class="line">      dispatch(action)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> store</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ€è€ƒ:å¦‚æœç»§ç»­å¢åŠ é€»è¾‘,è®¡ç®—æ¯æ¬¡dispatchæ‰§è¡Œçš„æ—¶é—´ä»¥åŠè¾“å‡ºdispatchæ‰§è¡Œå‰çš„stateå’Œdispatchæ‰§è¡Œåçš„state.</p></blockquote><p>ç»§ç»­çœ‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> enhancer = <span class="function">(<span class="params">createStore</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">reducer, preloadedState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore(reducer, preloadedState)</span><br><span class="line">    <span class="keyword">let</span> dispatch = store.dispatch</span><br><span class="line">    store.dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(action)</span><br><span class="line">      <span class="built_in">console</span>.log(store.getState())</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>())</span><br><span class="line">      dispatch(action)</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>())</span><br><span class="line">      <span class="built_in">console</span>.log(store.getState())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> store</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿˜å¥½æˆ‘ä»¬åªæ˜¯å¢åŠ äº†ä¸€äº›ç®€å•çš„ä»£ç ,å‡è®¾å¦‚æœæ˜¯ä¸€äº›å¾ˆå¤æ‚çš„ä»£ç ,å„ç§é€»è¾‘çš„ä»£ç æ··æ‚çš„ä¸€èµ·,åæœŸä»£ç ç»´æŠ¤å·¥ä½œçš„éš¾åº¦è¿˜æ˜¯ä¸å°çš„.</p><p>åŒæ—¶æ€è€ƒå¦‚æœå…¶ä¸­éƒ¨åˆ†çš„ä»£ç éœ€è¦ç»™å…¶ä»–é¡¹ç›®å¤ç”¨å‘¢?æ€»ä¸èƒ½è€æ˜¯copyä»£ç å§.è¿™æ—¶å€™è¯¥ä¸­é—´ä»¶å‡ºåœºäº†</p></blockquote><h2 id="middlewareä¸­é—´ä»¶"><a href="#middlewareä¸­é—´ä»¶" class="headerlink" title="middlewareä¸­é—´ä»¶"></a>middlewareä¸­é—´ä»¶</h2><p>æ¯ä¸ª<code>middleware</code>æ˜¯ä¸ªç‹¬ç«‹çš„é«˜é˜¶å‡½æ•°. <code>middleware</code>ä¸­é—´ä»¶ç®€å•çš„ç†è§£å°±æ˜¯åœ¨<code>dispatch(action)</code>å‰åæ·»åŠ è‡ªå·±çš„ä»£ç .middlewareç±»ä¼¼æ´‹è‘±åœˆæ¨¡å‹. </p><p><img src="/images/Snipaste_2018-08-08_18-08-31.png" alt="Snipaste_2018-08-08_18-08-31"></p><p>é€šè¿‡å›¾å¯ä»¥çœ‹å‡º,store.dispatch(ç»è¿‡å°è£…çš„dispatch)å,ä»£ç æ‰§è¡Œè·¯å¾„æ˜¯mid1 -&gt; mid2 -&gt; mid3 -&gt; dispatch(åŸstore.dispatch) -&gt; mid3 -&gt; mid2 -&gt; mid1.</p><h2 id="applyMiddleware"><a href="#applyMiddleware" class="headerlink" title="applyMiddleware"></a>applyMiddleware</h2><p><code>applyMiddleware</code>å‡½æ•°çš„æœ¬è´¨æ˜¯åˆ›å»ºä¸€ä¸ª<code>enhancer</code>,å®ƒä¼ å…¥å¤šä¸ªä¸­é—´ä»¶å‡½æ•°,åœ¨è¿”å›çš„<code>enhancer</code>ä¸­ä¸€å±‚å±‚åœ°å°†åŸstore.dispatchåµŒå¥—.</p><p>å…ˆçœ‹çœ‹ä¸­é—´ä»¶çš„å‡½æ•°ç­¾å,å‡½æ•°ç­¾åæ¯”è¾ƒå¤æ‚,å†…éƒ¨æœ‰2å±‚çš„å‡½æ•°åµŒå¥—.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‰ç…§å±‚æ¬¡,ä¾æ¬¡å‚æ•°ä¸º</span></span><br><span class="line"><span class="comment">// 1. storeå¯¹è±¡,</span></span><br><span class="line"><span class="comment">// 2.ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„æœ€å†…å±‚å‡½æ•°æˆ–è€…æ˜¯åŸstore.dispatch,</span></span><br><span class="line"><span class="comment">// 3. ä¸Šä¸€å±‚ä¸­é—´ä»¶è¿”å›çš„actionå¯¹è±¡,æˆ–è€…æ˜¯æœ€å¤–å±‚è°ƒç”¨store.dispatchå‡½æ•°çš„å‚æ•°action</span></span><br><span class="line"><span class="keyword">const</span> middleware = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹çœ‹ä¸Šé¢è®²åˆ°çš„ä¸‰ä¸ªéœ€æ±‚ç”¨ä¸­é—´ä»¶çš„å®ç°ä»£ç .</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ‰§è¡Œdispatchå‰è¾“å‡ºaction</span></span><br><span class="line"><span class="keyword">const</span> actionLogMiddleware = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(action)</span><br><span class="line">  <span class="keyword">let</span> r = next(action)</span><br><span class="line">  <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ‰§è¡Œdispatchå‰åè¾“å‡ºstate</span></span><br><span class="line"><span class="keyword">const</span> stateLogMiddleware = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(store.getState())</span><br><span class="line">  <span class="keyword">let</span> r = next(action)</span><br><span class="line">  <span class="built_in">console</span>.log(store.getState())</span><br><span class="line">  <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºdispatchçš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line"><span class="keyword">const</span> timeLogMiddleware = <span class="function"><span class="params">store</span> =&gt;</span> next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timeStart'</span>,<span class="keyword">new</span> <span class="built_in">Date</span>())</span><br><span class="line">  <span class="keyword">let</span> r = next(action)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timeEnd'</span>,<span class="keyword">new</span> <span class="built_in">Date</span>())</span><br><span class="line">  <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'exec reducer'</span>)</span><br><span class="line">  <span class="keyword">if</span>(action.type === <span class="string">'add'</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æˆ‘åˆšæ‰è¯´è¿‡applyMiddlewareå‡½æ•°çš„æœ¬è´¨æ˜¯åˆ›å»ºä¸€ä¸ªenhancer</span></span><br><span class="line"><span class="keyword">const</span> enhancer = applyMiddleware(actionLogMiddleware, stateLogMiddleware, timeLogMiddleware)</span><br><span class="line"><span class="keyword">let</span> store = createStore(reducer, enhancer)</span><br><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'add'</span> &#125;)</span><br><span class="line"><span class="comment">// å„ä¸­é—´ä»¶ä¾æ¬¡è¾“å‡º</span></span><br><span class="line"><span class="comment">// actionLogMiddleware:    &#123; type: 'add' &#125;</span></span><br><span class="line"><span class="comment">// stateLogMiddleware:     0</span></span><br><span class="line"><span class="comment">// timeLogMiddleware:      timeStart xxxx</span></span><br><span class="line"><span class="comment">// reducer:                exec reducer</span></span><br><span class="line"><span class="comment">// timeLogMiddleware:    timeEnd xxxx</span></span><br><span class="line"><span class="comment">// stateLogMiddleware:    1</span></span><br></pre></td></tr></table></figure><p>æ¥çœ‹çœ‹<code>applyMiddleware</code>æ˜¯æ€ä¹ˆå®ç°è¿™ç‚¹çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123; <span class="comment">// middlewares = [mid1, mid2, mid3]</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> (...args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºåŸstore</span></span><br><span class="line">    <span class="keyword">const</span> store = createStore(...args)</span><br><span class="line">    <span class="comment">// åœ¨Dispatchingä¸­æ·»åŠ ä¸­é—´ä»¶ä¼šæŠ¥ä¸€ä¸‹é”™è¯¯,ä½†æ˜¯åœ¨storeè¿˜æœªåˆ›å»º,dispatchæ€ä¹ˆä¼šæ‰§è¡Œ?è¿™ç‚¹ä¸å¤ªæ˜ç™½</span></span><br><span class="line">    <span class="keyword">let</span> dispatch = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`Dispatching while constructing your middleware is not allowed. `</span> +</span><br><span class="line">        <span class="string">`Other middleware would not be applied to this dispatch.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªç±»storeå¯¹è±¡,åŒ…å«getStateå‡½æ•°å’Œä¸Šé¢æˆ‘ä»¬åˆšå®šä¹‰çš„dispatchå‡½æ•°</span></span><br><span class="line">    <span class="comment">// ä¸è¿‡åœ¨åé¢dispatchæŒ‡å‘åˆå˜äº†,æ‰€ä»¥åœ¨ä¸­é—´ä»¶è®¿é—®åˆ°çš„store.dispatchå‡½æ•°å…¶å®æ˜¯å°è£…è¿‡çš„dispatch</span></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç±»storeå¯¹è±¡ä½œä¸ºå‚æ•°,éå†æ‰§è¡Œæ‰€æœ‰çš„ä¸­é—´ä»¶</span></span><br><span class="line">    <span class="comment">// chainæ˜¯ä»¥ä¸‹ç»“æ„çš„å‡½æ•°æ„æˆçš„æ•°ç»„</span></span><br><span class="line">    <span class="comment">// func = (next) =&gt; action =&gt; &#123; /*åœ¨è¿™é‡Œå¯ä»¥è®¿é—®åˆ°ç±»storeå¯¹è±¡*/ &#125;</span></span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// composeå‡½æ•°æ˜¯ä¸€ä¸ªå½’å¹¶æ–¹æ³•,å¯¹chainåšäº†ä¸€æ¬¡å½’å¹¶æ“ä½œ,composeå‡½æ•°çš„è§£æè¯·çœ‹ä¸‹ä¸€å°èŠ‚</span></span><br><span class="line">    <span class="comment">// è¿™æ®µä»£ç æ˜¯å¯¹åŸdispatchçš„å°è£…</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯èƒ½ä¸å¤ªå¥½ç†è§£,å…ˆè·³è¿‡,çœ‹å®Œcomposeè§£æåå†å›æ¥çœ‹è¿™é‡Œ</span></span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›åŸstoreçš„æ‹·è´,å¹¶å°†åŸdispatchå‡½æ•°æ›¿æ¢æˆå°è£…è¿‡çš„dispatchå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h2><p>composeæ˜¯ä¸€ä¸ªå½’å¹¶æ–¹æ³•, ä½œç”¨æ˜¯å°†ä¸­é—´ä»¶çš„å±‚å±‚åµŒå¥—æ‰§è¡Œ,æ¥çœ‹çœ‹æºç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰å‚æ•°æ—¶ç›´æ¥è¿”å› arg =&gt; arg </span></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åªæœ‰ä¸€ä¸ªå‚æ•°æ—¶,ç›´æ¥è¿”å›å‚æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹å‚æ•°å½’å¹¶æ‰§è¡Œ,çœ‹ä¸‹ä¸€æ®µä»£ç ,äº†è§£å®ƒçš„ä½œç”¨</span></span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (...args) =&gt; a(b(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> func1 = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123; <span class="comment">/**/</span> &#125;</span><br><span class="line"><span class="keyword">const</span> func2 = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123; <span class="comment">/**/</span> &#125;</span><br><span class="line"><span class="keyword">const</span> func3 = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123; <span class="comment">/**/</span> &#125;</span><br><span class="line"><span class="keyword">const</span> chain = [func1, func2, func3]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> func4 = compose(...chain)</span><br><span class="line"><span class="comment">// æœ€åhunc4æ˜¯è¿™ä¸ªæ ·å­</span></span><br><span class="line"><span class="comment">// func4 = (args) =&gt; func1(func2(func3(args)))</span></span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ,ä½ éœ€è¦æ¨¡ç³Šåœ°æ˜ç™½composeåšäº†å“ªäº›äº‹æƒ…å°±å¥½äº†,æœ€åæ‹¿ä¸€ä¸ªä¾‹å­åšä¸€æ¬¡å…³é”®ä»£ç çš„æ‰§è¡Œè§£æ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mid1 = <span class="function"><span class="params">store1</span> =&gt;</span> next1 =&gt; <span class="function"><span class="params">action1</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* do something 1 */</span></span><br><span class="line">  <span class="keyword">let</span> r1 = next1(action1)</span><br><span class="line">  <span class="comment">/* do something1 1 */</span></span><br><span class="line">  <span class="keyword">return</span> r1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mid2 = <span class="function"><span class="params">store2</span> =&gt;</span> next2 =&gt; <span class="function"><span class="params">action2</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* do something 2 */</span></span><br><span class="line">  <span class="keyword">let</span> r2 = next2(action2)</span><br><span class="line">  <span class="comment">/* do something 2 */</span></span><br><span class="line">  <span class="keyword">return</span> r2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mid3 = <span class="function"><span class="params">store3</span> =&gt;</span> next3 =&gt; <span class="function"><span class="params">action3</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* do something 3 */</span></span><br><span class="line">  <span class="keyword">let</span> r3 = next3(action3)</span><br><span class="line">  <span class="comment">/* do something 3 */</span></span><br><span class="line">  <span class="keyword">return</span> r3</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  æ‰§è¡ŒapplyMiddleware(mid1,mid2)</span></span><br><span class="line">applyMiddleware(mid1, mid2, mid3)&#123;</span><br><span class="line">  <span class="keyword">const</span> middlewares = [mid1, mid2, mid3]</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> (reducer, preloadedState)) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore(reducer, preloadedState)</span><br><span class="line">    <span class="keyword">let</span> dispatch = <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'xxxx'</span>) &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç±»storeå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(...args)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    <span class="comment">// å¾—åˆ°çš„chainä¸ºä»¥ä¸‹ç»“æ„,ä½†mapéå†æ‰§è¡Œåéƒ½ç”Ÿæˆäº†ä¸€ä¸ªé—­åŒ…,</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æ¯ä¸ªå‡½æ•°éƒ½å¯ä»¥è®¿é—®åˆ°middlewareAPIå¯¹è±¡,</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤æ—¶middlewareAPI.dispatchè¿˜æ˜¯é‚£ä¸ªæŠ›å‡ºé”™è¯¯çš„ç®­å¤´å‡½æ•°</span></span><br><span class="line">    chain = [</span><br><span class="line">      next1 =&gt; <span class="function"><span class="params">action1</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* do something 1 */</span></span><br><span class="line">        <span class="keyword">let</span> r1 = next1(action1)</span><br><span class="line">        <span class="comment">/* do something 1 */</span></span><br><span class="line">        <span class="keyword">return</span> r1</span><br><span class="line">      &#125;,</span><br><span class="line">      next2 =&gt; <span class="function"><span class="params">action2</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* do something 2 */</span></span><br><span class="line">        <span class="keyword">let</span> r2 = next2(action2)</span><br><span class="line">        <span class="comment">/* do something 2 */</span></span><br><span class="line">        <span class="keyword">return</span> r2</span><br><span class="line">      &#125;,</span><br><span class="line">      next3 =&gt; <span class="function"><span class="params">action3</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* do something 3 */</span></span><br><span class="line">        <span class="keyword">let</span> r3 = next3(action3)</span><br><span class="line">        <span class="comment">/* do something 3 */</span></span><br><span class="line">        <span class="keyword">return</span> r3</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line">    <span class="comment">// compose(...chain)æ‰§è¡Œç»“æœç±»ä¼¼ä»¥ä¸‹ç»“æ„</span></span><br><span class="line">    <span class="comment">// æ³¨æ„,æ¯ä¸ªnextå‡½æ•°åŒæ ·éƒ½æ˜¯é€šè¿‡é—­åŒ…çš„å½¢å¼å»è®¿é—®çš„,è€Œä¸æ˜¯ä¸‹é¢ä»£ç è¿™æ ·,ä½†æ•´ä½“ç»“æ„ç±»ä¼¼</span></span><br><span class="line">    <span class="keyword">let</span> preDispatch = <span class="function">(<span class="params">next3</span>) =&gt;</span> (action1) =&gt; &#123;</span><br><span class="line">      <span class="comment">/* do something 1 */</span></span><br><span class="line">      <span class="keyword">let</span> next1 = <span class="function">(<span class="params">action2</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* do something 2 */</span></span><br><span class="line">        <span class="keyword">let</span> next2 = <span class="function">(<span class="params">action3</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">/* do something 3 */</span></span><br><span class="line">          <span class="keyword">let</span> r3 = next3(action3)</span><br><span class="line">          <span class="comment">/* do something 3 */</span></span><br><span class="line">          <span class="keyword">return</span> r3</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> r2 = next2(action2)</span><br><span class="line">        <span class="comment">/* do something 2 */</span></span><br><span class="line">        <span class="keyword">return</span> r2</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> r1 = next1(action1)</span><br><span class="line">      <span class="comment">/* do something 1 */</span></span><br><span class="line">      <span class="keyword">return</span> r1</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€åä¼ å…¥åŸsotre.dispatchæ‰§è¡Œå¾—åˆ°å°è£…è¿‡çš„dispatchå‡½æ•°</span></span><br><span class="line">    <span class="comment">// dispatch = preDispatch(sotre.dispatch)</span></span><br><span class="line">    <span class="comment">// æ³¨æ„,æ­¤æ—¶dispatchçš„æŒ‡é’ˆæ”¹å˜äº†,ä¸Šé¢middlewareAPI.dispatchä¹Ÿå°±æŒ‡å‘äº†å°è£…è¿‡çš„dispatch</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æ¯ä¸ªä¸­é—´ä»¶æ˜¯å¯ä»¥è°ƒç”¨å°è£…è¿‡çš„dispatchå‡½æ•°çš„</span></span><br><span class="line">    <span class="comment">// æœ€åå¾—åˆ°çš„dispatchæ˜¯è¿™æ ·çš„</span></span><br><span class="line">    dispatch = <span class="function">(<span class="params">action1</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* do something 1 */</span></span><br><span class="line">      <span class="keyword">let</span> next1 = <span class="function">(<span class="params">action2</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* do something 2 */</span></span><br><span class="line">        <span class="keyword">let</span> next2 = <span class="function">(<span class="params">action3</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">/* do something 3 */</span></span><br><span class="line">          <span class="comment">// æ‰§è¡ŒåŸstore.dispatch</span></span><br><span class="line">          <span class="keyword">let</span> r3 = store.dispatch(action3)</span><br><span class="line">          <span class="comment">/* do something 3 */</span></span><br><span class="line">          <span class="keyword">return</span> r3</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> r2 = next2(action2)</span><br><span class="line">        <span class="comment">/* do something 2 */</span></span><br><span class="line">        <span class="keyword">return</span> r2</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> r1 = next1(action1)</span><br><span class="line">      <span class="comment">/* do something 1 */</span></span><br><span class="line">      <span class="keyword">return</span> r1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›åŸstoreçš„æ‹·è´,å¹¶å°†åŸdispatchå‡½æ•°æ›¿æ¢æˆå°è£…è¿‡çš„dispatchå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤,applyMiddlewareæºç è§£æå®Œæˆ . è¦æƒ³æ›´å¥½äº†è§£redux,è¿˜æ˜¯æ¨èè‡ªå·±å†™ä¸€éç®€å•çš„ç”¨ä¾‹,ä¸€æ­¥æ­¥è°ƒè¯•,è¾“å‡ºå…³é”®æ•°æ®æ‰èƒ½é€å½»åœ°äº†è§£reduxçš„æ‰§è¡Œæœºåˆ¶.</p>]]></content>
      
      
        <tags>
            
            <tag> redux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>redux-æºç è§£æ(1)-createStore</title>
      <link href="/2018/07/25/redux-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(1)-createStore/"/>
      <url>/2018/07/25/redux-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(1)-createStore/</url>
      <content type="html"><![CDATA[<h2 id="createStore"><a href="#createStore" class="headerlink" title="createStore"></a>createStore</h2><p>é¡¾åæ€ä¹‰,ç”¨å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>store</code>å¯¹è±¡,<code>store</code>è´Ÿè´£ä¿å­˜å’Œç®¡ç†<code>state</code>,åˆ©ç”¨é—­åŒ…ç‰¹æ€§,å¤–éƒ¨æ— æ³•ç›´æ¥ä¿®æ”¹<code>state</code>,åªèƒ½é€šè¿‡<code>store.getState()</code>æ¥è¯»å–<code>state</code>,æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹<code>createStore</code>å‡½æ•°çš„å‡½æ•°ç­¾å</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createStore(reducer, [preloadedState], [enhancer])</span><br></pre></td></tr></table></figure><p>åœ¨<code>creatStore</code>å‡½æ•°å‰å‡ è¡Œæœ‰ä¸€æ®µä»£ç ,å®ç°äº†<code>createStore</code>å‡½æ•°çš„é‡è½½,æ‰€ä»¥<code>createStore</code>å‡½æ•°è¿˜å¯ä»¥è¿™ä¹ˆè°ƒç”¨</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">createStore(reducer, enhancer)&#123;</span><br><span class="line">  <span class="keyword">return</span> store = &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>createStore</code>è¿”å›ä¸€ä¸ª<code>stre</code>å¯¹è±¡,æˆ‘ä»¬æ¥çœ‹çœ‹<code>createStore</code>çš„å†…éƒ¨ç»“æ„,ç®€å•åœ°è¯´æ˜ä¸‹éƒ¨åˆ†ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">createStore(reducer, preloadedState, enhancer) &#123;</span><br><span class="line">  <span class="comment">// å®ç°å‡½æ•°é‡è½½</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// æ ¡éªŒenhancer,å¯¹storeè¿›è¡Œå¢å¼º,æœ¬ç¯‡æ–‡ç« æš‚æ—¶ä¸åšåˆ†æ</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// æ ¡éªŒreducer,reducerå¿…é¡»æ˜¯ä¸ªçº¯å‡½æ•°,reduceråé¢ä¼šæœ‰å•ç‹¬è¯´æ˜</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> reducer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the reducer to be a function.'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// ä¿å­˜ç›¸å…³æ•°æ®</span></span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer</span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState</span><br><span class="line">  <span class="keyword">let</span> currentListeners = []</span><br><span class="line">  <span class="keyword">let</span> nextListeners = currentListeners</span><br><span class="line">  <span class="keyword">let</span> isDispatching = <span class="literal">false</span> <span class="comment">// reduceræ˜¯å¦æ‰§è¡Œä¸­</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è‹¥nextListenerså’ŒcurrentListenerså…¨ç­‰,ç»™nextListenersèµ‹å€¼currentListenersçš„æµ…æ‹·è´</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">// è¯»å–storeçš„state.</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„!!!åœ¨reduceræ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•ä½¿ç”¨è¯¥å‡½æ•°å»è¯»å–state</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">'åœ¨reduceræ‰§è¡Œä¸­ä¸èƒ½é€šè¿‡getStateè¯»å–state,'</span>+</span><br><span class="line">        <span class="string">'ä»reducerä¸­çš„stateå‚æ•°ä¸­è¯»å–,è€Œä¸æ˜¯é€šè¿‡getState'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ·»åŠ è®¢é˜…è€…,å‚æ•°æ˜¯ä¸ªå‡½æ•°.æ³¨æ„!!åœ¨reduceræ‰§è¡Œè¿‡ç¨‹ä¸­æ— æ³•è°ƒç”¨è¯¥å‡½æ•°</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;<span class="comment">/*åé¢ä¼šè¯¦ç»†è¯´æ˜*/</span>&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// å‘é€atcion</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;<span class="comment">/*åé¢ä¼šè¯¦ç»†è¯´æ˜*/</span>&#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// æ›¿æ¢reducer</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¡éªŒå‚æ•°ç±»å‹,å¿…é¡»ä¸ºå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the nextReducer to be a function.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    <span class="comment">// æ›¿æ¢å®Œæˆå,å‘é€REPLACEçš„action</span></span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: ActionTypes.REPLACE &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// åˆ›å»ºstoreçš„æœ€åä¸€æ­¥</span></span><br><span class="line">  <span class="comment">// å‘é€INITçš„action</span></span><br><span class="line">  <span class="comment">// åœ¨reducerä¸­ä¸è¯¥å¯¹typeä¸ºActionTypes.INITçš„actionç»è¡Œç²¾ç¡®å‘½ä¸­</span></span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="reducer"><a href="#reducer" class="headerlink" title="reducer"></a>reducer</h2><p><code>reducer</code>æ˜¯ä¸€ä¸ªçº¯å‡½æ•°,å®ƒæ˜¯å”¯ä¸€èƒ½ä¿®æ”¹<code>store</code>çŠ¶æ€çš„é€”å¾„,å½“<code>store</code>å‘é€ä¸€ä¸ª<code>action</code>æ—¶<code>reducer</code>ä¼šåœ¨<code>store</code>å†…éƒ¨è¢«æ‰§è¡Œ,å®ƒçš„å‡½æ•°ç­¾åæ˜¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// state: å½“å‰storeçš„state</span></span><br><span class="line"><span class="comment">// action: å¤–éƒ¨ä»£ç æ‰§è¡Œstore.dispatchä¼ å…¥çš„action</span></span><br><span class="line">reducer(state, action)&#123;</span><br><span class="line">    <span class="comment">/* é€šè¿‡å¯¹action.typeçš„åˆ¤æ–­,æ‰§è¡Œç›¸åº”ä»£ç ,è¿”å›ä¸€ä¸ªæ–°çš„state */</span></span><br><span class="line">    <span class="comment">/* reduceræ˜¯ä¸€ä¸ªçº¯å‡½æ•°,æ‰€ä»¥ä¸è¦å¯¹stateè¿›è¡Œä¿®æ”¹ */</span></span><br><span class="line">    <span class="keyword">return</span> newState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p> <code>reducer</code>å†…éƒ¨æ€ä¹ˆå†™éƒ½è¡Œ,åªè¦æ˜¯ä¸ªçº¯å‡½æ•°,è¿”å›ä¸€ä¸ªæ–°çš„<code>state</code>å°±å¯ä»¥,è¿™é‡Œå»ºè®®å¼•å…¥<code>immutable</code></p></blockquote><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„reducerä¾‹å­, å¯¹stateè¿›è¡ŒåŠ å‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;__DO_NOT_USE__ActionTypes <span class="keyword">as</span> ActionTypes&#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = <span class="number">0</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'increment'</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'decrement'</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> ActionTypes.INIT: </span><br><span class="line">    <span class="comment">// æ³¨æ„!!!!</span></span><br><span class="line">    <span class="comment">// è¯¥caseæ˜¯ä¸ªé”™è¯¯çš„ç¤ºä¾‹,ä¸èƒ½ç›´æ¥å‘½ä¸­ ActionTypes.INIT</span></span><br><span class="line">    <span class="comment">// ä»reduxçš„å‘½åå¯ä»¥çœ‹,ä¸åº”åœ¨reduxçš„å¤–éƒ¨ä½¿ç”¨è¯¥å€¼</span></span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe"></a>subscribe</h2><p><code>subscribe</code>ç”¨æ¥æ·»åŠ è®¢é˜…,å½“<code>store</code>å‘é€ä¸€ä¸ª<code>action</code>æ—¶,è¢«è®¢é˜…çš„å‡½æ•°å°±ä¼šæ‰§è¡Œ.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å‚æ•°æ ¡éªŒ</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the listener to be a function.'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// reduceræ‰§è¡Œä¸­æ— æ³•æ·»åŠ è®¢é˜…</span></span><br><span class="line">  <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">'reduceræ‰§è¡Œä¸­æ— æ³•æ·»åŠ è®¢é˜…'</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²è®¢é˜…çš„æ ‡è¯†</span></span><br><span class="line">  <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line">  ensureCanMutateNextListeners()</span><br><span class="line">  <span class="comment">// åœ¨è®¢é˜…é˜Ÿåˆ—ä¸­pushä¸€ä¸ªlistener</span></span><br><span class="line">  nextListeners.push(listener)</span><br><span class="line">  <span class="comment">// è¿”å›è¯¥æ¬¡è®¢é˜…çš„å–æ¶ˆè®¢é˜…å‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œè¿‡å–æ¶ˆè®¢é˜…çš„å‡½æ•°å,å†æ¬¡è°ƒç”¨,åé¢çš„ä»£ç å°±ä¸éœ€è¦æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// reduceræ‰§è¡Œä¸­æ— æ³•å–æ¶ˆè®¢é˜…</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">'reduceræ‰§è¡Œä¸­æ— æ³•å–æ¶ˆè®¢é˜…'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ‡è®°å–æ¶ˆè®¢é˜…</span></span><br><span class="line">    isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners()</span><br><span class="line">    <span class="comment">// ä»è®¢é˜…é˜Ÿåˆ—ä¸­åˆ é™¤è®¢é˜…çš„äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">const</span> index = nextListeners.indexOf(listener)</span><br><span class="line">    nextListeners.splice(index, <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨å‘é€actionå,reduceræ‰§è¡Œå®Œæ¯•,ä¼šä¾æ¬¡æŒ‰æ·»åŠ è®¢é˜…çš„<strong>é¡ºåº</strong>æ‰§è¡Œ<code>listeners</code></p></blockquote><h2 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a>dispatch</h2><p><code>dispatch</code>ç”¨æ¥å‘é€action,åœ¨<code>dispatch</code>å†…éƒ¨æ‰§è¡Œ<code>reducer</code>,æ‰§è¡Œè¿”å›çš„ç»“æœå°±æ˜¯storeçš„æœ€æ–°<code>state</code>, ç„¶å<strong>æŒ‰é¡ºåº</strong>æ‰§è¡Œ<code>listeners</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">   <span class="comment">// actionæ ¼å¼çš„æ ¡éªŒ</span></span><br><span class="line">   <span class="keyword">if</span> (!isPlainObject(action)) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'actionçš„æ ¼å¼å¿…é¡»æ˜¯ç®€å•çš„å¯¹è±¡,ç”¨ä¸­é—´ä»¶å¤„ç†å¼‚æ­¥çš„action'</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'actionå¿…é¡»è¦æœ‰typeå±æ€§'</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'æœ‰reduceræœªæ‰§è¡Œå®Œæ¯•,æ— æ³•å‘é€action'</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     isDispatching = <span class="literal">true</span></span><br><span class="line">     <span class="comment">// æ‰§è¡Œreducer,æ‰§è¡Œå®Œæ¯•åèµ‹å€¼èµ‹å€¼ç»™state,æ›´æ–°çŠ¶æ€</span></span><br><span class="line">     currentState = currentReducer(currentState, action)</span><br><span class="line">     <span class="comment">// è¿˜è®°å¾—å‰é¢reducerçš„ä¾‹å­å—,å›å¤´çœ‹çœ‹,currentReducerå°±æ˜¯é‚£ä¸ªå‡½æ•°</span></span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     isDispatching = <span class="literal">false</span></span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">   <span class="comment">// å¾ªç¯æ‰§è¡Œè®¢é˜…çš„äº‹ä»¶</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">     <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">     listener()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// æœ€åè¿”å›action</span></span><br><span class="line">   <span class="keyword">return</span> action</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…‰ä»<code>redux</code>çš„<code>creatStore</code>å‡½æ•°çš„ä»£ç å¯ä»¥çœ‹å‡ºæ•´ä¸ª<code>redux</code>çš„åŸºæœ¬è¿è¡Œæœºåˆ¶ç±»ä¼¼å‘å¸ƒè®¢é˜…æ¨¡å¼, <code>reducer</code>å°±æ˜¯è®¢é˜…çš„æ‰€æœ‰äº‹ä»¶,  <code>actio.type</code>æ˜¯äº‹ä»¶çš„ç±»å‹, <code>dispatch</code>ä¸€ä¸ª<code>action</code>å°±æ˜¯å¹¿æ’­ä¸€ä¸ªäº‹ä»¶.åŒºåˆ«åœ¨äº<code>redux</code>æ— æ³•ç›´æ¥æ·»åŠ äº‹ä»¶.ä½†å¯ä»¥é€šè¿‡<code>replaceReducer</code>å‡½æ•°æ›¿æ¢<code>reducer</code>. </p>]]></content>
      
      
        <tags>
            
            <tag> redux </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
